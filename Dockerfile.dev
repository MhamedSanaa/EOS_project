# Build Stage
ARG NODE_VERSION=20.9.0
FROM node:${NODE_VERSION}-alpine AS build

# Create app directory
WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm cache clean --force
RUN npm ci

# Copy the app source code and build the React app
COPY . .
RUN npm run build

# Nginx webserver Stage
FROM nginx:stable-alpine

# Install OpenSSL and create self-signed certificates
RUN apk add --no-cache openssl && \
    mkdir -p /etc/nginx/certs && \
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/certs/server.key -out /etc/nginx/certs/server.crt -subj "/CN=localhost"

# Copy the build output from the React app
COPY --from=build /app/build /usr/share/nginx/html

# Copy the custom Nginx configuration file for HTTP and HTTPS
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Expose both HTTP (80) and HTTPS (443)
EXPOSE 80 443

CMD [ "nginx", "-g", "daemon off;" ]